---
kind: Deployment
apiVersion: extensions/v1beta1
metadata:
  name: buzzy-app
  namespace: buzzy
spec:
  replicas: 1
  minReadySeconds: 10
  revisionHistoryLimit: 1
  strategy:
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  template:
    metadata:
      labels:
        app: buzzy-app
    spec:
      # hostAliases: # Use this for testing when DNS is not yet set up
      #   - ip: IHS IP ADDRESS, e.g. "192.168.1.1"
      #     hostnames:
      #       - "minio.buzzy.net.au"
      #       - "logging.buzzy.net.au"
      #       - "buzzy.net.au"
      imagePullSecrets:
        - name: dockerhub
      containers:
        - name: buzzy-app-container
          image: docker.io/buzzybuzz/buzzy-main:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
              protocol: TCP
          env:
            - name: PORT
              value: "8080"
            # - name: NODE_TLS_REJECT_UNAUTHORIZED
            #   value: '0'
            - name: ROOT_URL
              value: "https://buzzy.net"
            - name: LOG_TO_STDOUT
              value: "1"
            - name: MONGO_URL
              value:  "mongodb://<username>:<password>@mongo-service:27017/buzzy?replicaSet=replicaset&authSource=admin"
            - name: MONGO_OPLOG_URL
              value: "mongodb://<username>:<password>@mongo-service:27017/local?replicaSet=replicaset&authSource=admin"
            - name: MAIL_URL
              value: "smtp://someuser:somepassword@smtp.sendgrid.net:587"
            - name: METEOR_SETTINGS
              value: '{
                "loginExpirationInDays": 365,
                "jwtSecret": "change-to-some-very-long-secret-string",
                "REPORT_ABUSE_EMAILS": ["support@buzzy.buzz"],
                "BUZZY_MOBILE_CONFIG": {
                    "id": "com.<somedomain>.<some sub domain - eg app>",
                    "name": "<App Name>",
                    "description": "<App description>",
                    "version": "3.0.4"

                },
                "AWS_BUZZY_FILES": {
                  "enabled": true,
                  "accessKeyId": "ioueygr4t589",
                  "secretAccessKey": "7a863d41-2d8f-4143-bc8a-02501edbea6f",
                  "BUCKET_NAME": "buzzy-files",
                  "PUBLIC_BUCKET_NAME": "buzzy-files-public",
                  "S3_REGION": "",
                  "endpoint": "https://minio.buzzy.net.au",
                  "s3ForcePathStyle": true,
                  "signatureVersion": "v4"
                },
                "FIREBASE_DISABLED":{
                "enabled":false,
                "webApiKey":"firebaseapikey",
                "dynamicLinkDomain":"buzzy.page.link",
                "androidPackageName":"buzz.buzzy.app",
                "iosBundleId":"buzz.buzzy.app",
                "iosAppStoreId": "",
                "databaseURL":"https://folkloric-alpha-747.firebaseio.com",
                "serviceAccount":{
                    "type": "service_account",
                    "project_id": "projid",
                    "private_key_id": "firebaseapikey",
                    "private_key": "firebaseapikey",
                    "client_email": "firebase-adminsdk-firebaseapikey",
                    "client_id": "firebaseapikey",
                    "auth_uri": "https://accounts.google.com/o/oauth2/auth",
                    "token_uri": "https://accounts.google.com/o/oauth2/token",
                    "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
                    "client_x509_cert_url": "someurl"
                }
              },
                "PUSH_SETTINGS": {
                    "enabled":false,
                    "apn": {
                  "certDataFileName":"prod_cert.pem",
                  "keyDataFileName":"prod_key.pem",
                      "passphrase": "some-passphrase",
                        "production": true

                    },
                    "gcm": {
                        "apiKey": "<GCMKEY>"
                    },
                     "production": true,
                     "sound": true,
                     "badge": true,
                     "alert": true,
                     "vibrate": true,
                     "sendInterval": 5000,
                     "sendBatchSize": 100

                },
                "filepicker": {

                  "secret": "will become obsolete"

                },
                "MAIL_URL": "smtp://someuser:somepassword@smtp.sendgrid.net:587",
                "BUZZY_TESTING": false,
                "BUZZY_ADMIN_EMAIL": "someadminemail",
                "DEFAULT_OAUTH_PROVIDERS": {
                  "defaultOrganizationName": "Organisation name",
                  "providers": [
                    {
                      "clientID": "someClientID",
                      "clientSecret": "someSecret",
                      "connectionsOrgID": "someConnectionsOrgID",
                      "name": "this will be your team name on login",
                      "signInDomain": "https://my.connections.com",
                      "type": "ibmconnectionsonprem"
                    }
                  ]
                },
                "BUZZY_ADMIN_IDS": ["adminuserid"],
                "BUZZY_WATSON_USERID": "",
                "BUZZY_LOGGING_TOKEN": "somelongtoken",
                "BUZZY_ADMIN_TOKEN": "somelongtoken",
                "BUZZY_JSON_WEB_TOKE_SECRET": "somelongtoken",
                "BUZZY_DEBUG": false,
                "BUZZY_BASIC_BUZZ_ID": "blankbuzz",
                "BUZZY_WELCOME_BUZZ_ID": "setthisup",
                "CAMPAIGN_MONITOR": {
                  "AVOID": true,
                  "APIKEY": "",
                  "NEW_SUBSCRIBERS_LIST": "",
                  "WELCOME_SUBSCRIBERS_LIST": "",
                  "CONNECTIONS_ADMIN_LIST": "",
                  "UNPAID_AUTHOR_LIST": ""

                },
                "BUZZY_CREATE_DEFAULT_ACCOUNTS": {
                    "enabled": true,
                    "accounts": [{
                            "email": "someone@test.com",
                            "password": "somepassword",
                            "isAdmin":true
                        }
                    ]
                },
                "MAIL_INCOMING_DOMAIN": "needed if reply to comments via email are needed",
                "MAILGUN_KEY": "mailgun key for incoming MAIL_INCOMING_DOMAIN",
                "LOGINS": {
                  "GOOGLE": {
                    "clientId": "<somegoogleappid>.apps.googleusercontent.com",
                    "secret": "<googlesecret>",
                    "loginStyle": "redirect"
                  },
                  "MICROSOFT": {
                    "clientId": "<microsoft clientid>",
                    "secret": "<microsoft secret>"
                  },
                  "FACEBOOK": {
                    "appId": "<facebook app id>",
                    "secret": "<facebook secret>"
                  },
                  "SLACK": {
                    "secret": "slacksecretgoeshere"
                  },
                  "IBM_WATSON_WORKSPACE": {
                    "secret": "ibmwatsonsecretgoeshere",
                    "webhook_secret": "ibmwatsonsecretwebhookgoeshere"
                  }

                },
                "IBMConnectionsCloud": {
                  "display": "redirect",
                  "communityLimit": 1000,
                  "jwtSecret": "not needed unless in Cloud Catalog",
                  "salesSupportEmail": "not needed unless in Cloud Catalog",
                  "adminSupportEmails": ["not needed unless in Cloud Catalog"]

                },
                "TWITTER": {
                  "consumer_key": "",
                  "consumer_secret": "",
                  "access_token": "",
                  "access_token_secret": ""
                },
                "stripe": {
                  "enabled": false,
                  "testSecretKey": "sk_test_somekey",
                  "liveSecretKey": "sk_live_somekey",
                  "applicationFee": 0.005
                },
                "saml_idps": {

                  "acmeinc": {
                    "sso_login_url": "sign-inurl",
                    "sso_logout_url": " signouturl",
                    "certificates": ["certgoeshere"]
                  }

                },
                "public": {
                    "LICENSE_URL": "/assets/license.html",
                    "EMBEDLEY":"891b25c24ede41cf8ee5a4f0802a3cff",
                    "SUPRESS_NEW_USER_INVITES": false,
                    "LEAN_EMAIL_NOTIFICATIONS": true,
                    "S3FileExpiry": 6.048e+8,
                    "BUZZY_CHAT_BUZZ_ID": "idofgenericchatbuzz",
                    "PUSH_SETTINGS":{
                        "cordovaEnabled": false,
                        "firebaseEnabled": false

                    },
                      "SMS": {
                        "enabled": false
                        },
                  "AWS_BUZZY_FILES": {
                    "enabled":true,
                    "S3FileExpiry": 604800,
                    "BUCKET_NAME": "buzzy-files",
                    "PUBLIC_BUCKET_NAME": "buzzy-files-public",
                    "s3ForcePathStyle": true,
                    "URL_PATTERN": "https://minio.buzzy.net.au/buzzy-files"
                  },
                    "SUPERHERO_BUZZ_ID": "somebuzzid",
                  "CLOUD_IMAGE": {
                    "enabled": false,
                    "token": "for faster/compressed images see cloudimg.io",
                    "baseUrl": "https://<somekey>.cloudimg.io/s"
                  },
                  "GIPHY_ENABLED": false,
                  "GOOGLEMAPS_ENABLED": false,
                  "VIMEO": {
                    "enabled": true,
                    "accessToken": "key for VIMEO developer services for uploading and streaming video"

                  },
                  "GOOGLEBROWSER_API_KEY": "google key for API services like Maps etc",
                  "GOOGLEIOS_API_KEY": "specific Google key for IOS",
                  "IBMConnectionsOnPrem": {
                    "signInDomains": ["https://connections.isw.net.au","https://devconn6.internal.isw.net.au"]
                  },
                  "IBMConnectionsCloud": {
                    "adminWelcomeBuzzID": "ID of file when new cloud signup",
                    "defaultSignInDomain": "https://apps.collabservintegration.com",
                    "alternateSignInDomains": ["https://apps.ce.collabserv.com", "https://apps.ap.collabserv.com", "https://apps.na.collabserv.com"],
                    "defaultService": "connectionscloud",
                    "defaultClientID": "isv_buzzy_buzzy",
                    "headerVisible": true,
                    "display": "redirect",
                    "files": {
                      "options": [{
                          "option": "publicfiles",
                          "label": "Public files",
                          "url": "/files/oauth/api/documents/feed?visibility=public"
                        },
                        {
                          "option": "myfiles",
                          "label": "My files",
                          "url": "/files/oauth/api/myuserlibrary/feed"
                        },
                        {
                          "option": "myfilespublic",
                          "label": "My files",
                          "url": "/files/oauth/api/myuserlibrary/feed",
                          "params": { "visibility": "public" }
                        },
                        {
                          "option": "sharedwithme",
                          "label": "Files shared with me",
                          "url": "/files/oauth/api/documents/shared/feed?direction=inbound"
                        },
                        {
                          "option": "sharedbyme",
                          "label": "Files shared by me",
                          "url": "/files/oauth/api/documents/shared/feed?direction=outbound"
                        },
                        {
                          "option": "pinnedbyme",
                          "label": "Pinned by me",
                          "url": "/files/oauth/api/myfavorites/documents/feed"
                        },
                        {
                          "option": "communityfiles",
                          "label": "Community files",
                          "url": "/files/oauth/api/communitycollection/{communityId}/feed"
                        },
                        {
                          "option": "communityfilesupload",
                          "label": "Community files",
                          "url": "/files/oauth/api/communitylibrary/{communityId}/feed"
                        }
                      ]

                    }

                  },

                  "LOGINS": {
                        "SELF_REGISTRATION": {
                            "enabled": true
                        },
                        "REQUEST_REGISTRATION": {
                            "enabled": false,
                            "regoResourceID": ""
                        },
                        "APPSTORE": {
                            "enabled": false
                        },
                        "SECONDARY": {
                            "enabled": false
                        },
                        "INTEGRATIONS": {
                            "enabled": true
                        },
                    "PASSWORD": {
                      "enabled": true
                    },
                    "PASSWORDLESS": {
                        "enabled": true
                    },
                    "GOOGLE": {
                      "enabled": false
                    },
                    "MICROSOFT": {
                      "enabled": false,
                            "clientId": "msftclientid",
                            "secret": "msftsecret",
                            "scope": "User.Read",
                            "display": "popup"
                    },
                    "IBM_CONNECTIONS_CLOUD": {
                      "enabled": false
                    },
                    "IBM_CONNECTIONS_ONPREM": {
                      "enabled": true
                    },
                    "FACEBOOK": {
                      "enabled": false
                    },
                    "SLACK": {
                      "enabled": false,
                      "oauthCallback": "https://<domain>/_oauth/slack",
                      "clientID": "slack client ID"
                    },
                    "IBM_WATSON_WORKSPACE": {
                      "enabled": false,
                      "oauthCallback": "https://<domain>/_oauth/ibmwatsonworkspace",
                      "clientID": "WW client ID"
                    }
                  },
                  "BUZZY_REDIRECT": "/sign-in",
                  "BUZZY_CUSTOM": {
                    "NAME": "Orgnisation Name",
                    "APP_URL_IOS": "",
                    "APP_URL_ANDROID": "",
                    "LOGO_MAIN": "",
                    "LOGO_MAIL": "",
                    "LOGO_MAIL_WIDTH": "60",
                    "LOGO_MAIL_HEIGHT": "25",
                    "EMAIL_FOOTER": "",
                    "PROMO": "",
                    "PROMO_URL": "",
                    "SPLASH_IMAGE": "",
                    "WELCOME_IMAGE": ""
                  },
                  "BUZZY_VERSION": "3.0.1",
                  "BUZZY_DEBUG_CLIENT": true,
                  "BUZZY_PROVIDERS": [{
                      "name": "ibmconnectionscloud",
                      "displayName": "IBM Connections Cloud",
                      "domain": "https://apps.collabservintegration.com"
                    },
                    {
                      "name": "ibmconnectionsonprem",
                      "displayName": "IBM Connections On Premise",
                      "domain": "https://my.connections.url"
                    }
                  ],
                  "MIXPANEL_ENABLED": false,
                  "analyticsSettings": {
                    "Mixpanel": {
                      "token": "<mixpanel token>",
                      "people": true
                    }
                  },
                  "filepicker": {
                    "key": "will become obsolete",
                    "pickSignature": "will become obsolete",
                    "pickPolicy": "will become obsolete"
                  },
                  "BUZZY_LOGGING_SERVER": "https://logging.buzzy.net.au",
                    "BUZZY_TEMPLATE_SERVER": "https://a.buzzy.buzz",
                  "stripe": {
                    "enabled": false,
                    "debug": true,
                    "testClientID": "ca_<somekey>",
                    "liveClientID": "ca_<somekey>",
                    "testPublishableKey": "<somekey>",
                    "livePublishableKey": "<somekey>",
                    "expiryDates": [2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024],
                    "currencies":["afa","all","dzd","usd","eur","aoa","xcd","nok","ara","amd","awg","aud","azm","bsd","bhd","bdt","bbd","byr","bzd","xaf","bmd","btn","bob","bam","bwp","brl","gbp","bnd","bgn","bif","khr","cad","cve","kyd","clf","cny","cop","kmf","cdz","nzd","crc","hrk","cup","czk","dkk","djf","dop","tpe","egp","ern","eek","etb","fkp","fjd","xpf","gmd","gel","ghc","gip","gtq","gns","gwp","gyd","htg","hnl","hkd","huf","isk","inr","idr","irr","iqd","ils","jmd","jpy","jod","kzt","kes","kpw","krw","kwd","kgs","lak","lvl","lbp","lsl","lrd","lyd","chf","ltl","mop","mkd","mgf","mwk","myr","mvr","mro","mur","mxn","mdl","mnt","mad","mzm","mmk","nad","npr","ang","nic","xof","ngn","omr","pkr","pab","pgk","pyg","pei","php","pln","qar","rol","rub","rwf","wst","std","sar","scr","sll","sgd","sbd","sos","zar","lkr","shp","sdg","srg","szl","sek","syp","twd","tjr","tzs","thb","top","ttd","tnd","try","tmm","ugs","uah","sur","aed","uyu","uzs","vuv","vef","vnd","zmk"]
                  },
                    "USER_ONBOARDING":{
                  "tagsEnabled": false,
                        "tourEnabled": false
                },
                "USER_TAGS":{
                  "enabled":false,
                  "usersCanSelect":["interests"],
                  "list":[

                    {
                      "prompt":"What do you use Buzzy for?",
                      "category":"buzzyinterests",
                      "type":"multiple",
                      "tags":[
                        {"tag":"work","label":"Work"},
                        {"tag":"family","label":"Family"},
                        {"tag":"friends","label":"Friends"},
                        {"tag":"sportcoordination","label":"Sports Coordination"},
                        {"tag":"collaboration","label":"Collaboration"},
                        {"tag":"school","label":"School"},
                        {"tag":"event","label":"Event"},
                        {"tag":"travel","label":"Travel"}

                      ]

                    }
                  ]
                }
                }

              }'

---

apiVersion: v1
kind: Service
metadata:
  name: buzzy-service
  namespace: buzzy
spec:
  type: NodePort
  selector:
    app: buzzy-app
  ports:
    - port: 80
      targetPort: 8080
      name: http
      protocol: TCP

---

apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: buzzy-ingress
  namespace: buzzy
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "200m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/client-body-buffer-size: "200m"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
spec:
  # tls:
  #   - hosts:
  #       - buzzy.net.au
  #     secretName: buzzy-domain-secret
  rules:
     - host: buzzy.net.au
       http:
         paths:
           - backend:
              serviceName: buzzy-service
              servicePort: http
